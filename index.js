require('dotenv');
const {DateTime} = require('luxon');
const {Composer} = require('micro-bot');
const Extra = require('telegraf/extra');
const Markup = require('telegraf/markup');
const MongoClient = require('mongodb').MongoClient;
const geoTz = require('geo-tz')

const session = require('telegraf/session')
const Stage = require('telegraf/stage')
const Scene = require('telegraf/scenes/base')
const { enter, leave } = Stage

const googleMapsClient = require('@google/maps').createClient({ Promise: Promise });

const dbClient = new MongoClient(process.env.MONGODB_URI, {useNewUrlParser: true})

const moonCalc = require('./moonCalc');

const sendLocationKeyboard = Extra.markup(markup => markup.keyboard([markup.locationRequestButton('ðŸ“ ÐžÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹!')]).oneTime().resize())
const removeKb = Markup.removeKeyboard().extra()

const app = new Composer();

app.start((ctx) => ctx.reply(
  'ÐŸÑ€Ð¸Ð²ÐµÑ‚. ÐŸÑ€Ð¸ÑˆÐ»Ð¸ Ð¼Ð½Ðµ ÑÐ²Ð¾ÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð¸ Ñ ÑÐºÐ°Ð¶Ñƒ Ñ‚ÐµÐ±Ðµ ÐºÐ°ÐºÐ¾Ð¹ Ð² ÑÑ‚Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐµ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° ÑÐµÐ¹Ñ‡Ð°Ñ Ð»ÑƒÐ½Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ.' +
  'Ð¯ Ð·Ð°Ð¿Ð¾Ð¼Ð½ÑŽ ÑÑ‚Ð¸ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¸ Ð±ÑƒÐ´Ñƒ ÑÐ¾Ð¾Ð±Ñ‰Ð°Ñ‚ÑŒ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… Ð»ÑƒÐ½Ð½Ð¾Ð³Ð¾ Ñ†Ð¸ÐºÐ»Ð°',
  sendLocationKeyboard
  )
);
app.help((ctx) => ctx.reply(
  'ÐŸÑ€Ð¸ÑˆÐ»Ð¸ Ð¼Ð½Ðµ ÑÐ²Ð¾ÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ Ð¸ Ñ ÑÐºÐ°Ð¶Ñƒ Ñ‚ÐµÐ±Ðµ ÐºÐ°ÐºÐ¾Ð¹ Ð² ÑÑ‚Ð¾Ð¹ Ñ‚Ð¾Ñ‡ÐºÐµ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° ÑÐµÐ¹Ñ‡Ð°Ñ Ð»ÑƒÐ½Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ\n' +
  'Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ñ‘Ñ‚ÑÑ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ…, Ñ‡Ñ‚Ð¾ Ñƒ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼ ÐµÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº gps',
  sendLocationKeyboard
  )
);

const setLocationScene = new Scene('location');
setLocationScene.enter(async ctx => {
  return ctx.reply(
    'ÐÐ°Ð¿Ð¸ÑˆÐ¸ Ð³Ð´Ðµ Ñ‚Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸ÑˆÑŒÑÑ, Ð¸Ð»Ð¸ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸ Ð¼Ð½Ðµ ÑÐ²Ð¾Ð¸ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¸ Ñ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°ÑŽ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ Ð°ÑÑ‚Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¾Ð±ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ.\n',
    sendLocationKeyboard
  )
});
setLocationScene.on('location', async ctx => {
  try {
    const {message: {location: {latitude: lat, longitude: lng}}} = ctx

    if (!latitude || !longitude)
      return ctx.reply('ÐÐµ Ð¼Ð¾Ð³Ñƒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ ÑÐ»ÑƒÐ¶Ð±Ñ‹ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸')

    await saveCoordinatesToChatsCollection(ctx, [ lat, lng ])
    await ctx.reply(`Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€ÑŽ. Ð—Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ð» ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹:\nÐ”Ð¾Ð»Ð³Ð¾Ñ‚Ð°: ${lng}\nÐ¨Ð¸Ñ€Ð¾Ñ‚Ð°: ${lat}\n`)

    const [timeZone] = geoTz(lat, lng);
    const moonDay = moonCalc.calculateMoonDayFor(DateTime.fromObject({zone: timeZone}).toJSDate(), [lat, lng]);
    const reportMessage = createReportMessage({moonDay})
    await ctx.replyWithMarkdown(reportMessage, removeKb)
  } catch (err) {
    console.error(err);
    await ctx.reply('Ð¡Ð¾Ñ€ÑÐ½. Ð’Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸ Ð¾Ð± ÑÑ‚Ð¾Ð¼ Ð’ÐµÑ‚Ð°Ð»Ñƒ', removeKb)
  } finally {
    leave()
  }
});
setLocationScene.on('text', async ctx => {
  try {
    const { message: { text } } = ctx
    const geoCodingResponse = await googleMapsClient.geocode({ address: text }).asPromise();
    if (!geoCodingResponse.json.results.length)
      return ctx.reply(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹: ${text}.` +
       `ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð²Ð²ÐµÑÑ‚Ð¸ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐ³Ð¾ Ð½Ð°ÑÐµÐ»Ñ‘Ð½Ð½Ð¾Ð³Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð°`);

    const { json: { results: [ { geometry: { location: { lat, lng } } } ] } } = geoCodingResponse;

    await saveCoordinatesToChatsCollection(ctx, [ lat, lng ]);
    await ctx.reply(`Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€ÑŽ. Ð—Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ð» ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹:\nÐ”Ð¾Ð»Ð³Ð¾Ñ‚Ð°: ${lat}\nÐ¨Ð¸Ñ€Ð¾Ñ‚Ð°: ${lng}\n`);

    const [timeZone] = geoTz(lat, lng);
    const moonDay = moonCalc.calculateMoonDayFor(DateTime.fromObject({zone: timeZone}).toJSDate(), [lat, lng]);
    const reportMessage = createReportMessage({moonDay})
    await ctx.replyWithMarkdown(reportMessage, removeKb)
    leave()
  } catch (e) {
    console.error(err);
    await ctx.reply('Ð¡Ð¾Ñ€ÑÐ½. Ð’Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸ Ð¾Ð± ÑÑ‚Ð¾Ð¼ Ð’ÐµÑ‚Ð°Ð»Ñƒ', removeKb)
  }
})

app.use(session())

const stage = new Stage([setLocationScene], { ttl: 10 })
app.use(stage.middleware())

app.command('location', enter('location'))

app.command('day', async ({db, message, reply, replyWithMarkdown}) => {
  try {
    const chat = await db.collection('chats').findOne({chatId: message.chat.id})
    if (!chat) return reply('ÐŸÑ€Ð¸ÑˆÐ»Ð¸ Ð¼Ð½Ðµ ÑÐ²Ð¾Ð¸ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸ ÑÑ‚Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ ÑÐ½Ð¾Ð²Ð°', sendLocationKeyboard)

    const {coordinates: [lat, lng]} = chat;
    const [timeZone] = geoTz(lat, lng);
    const moonDay = moonCalc.calculateMoonDayFor(DateTime.fromObject({zone: timeZone}).toJSDate(), [lat, lng]);
    const reportMessage = createReportMessage({moonDay})
    return replyWithMarkdown(reportMessage)
  } catch (err) {
    console.error(err)
    reply('Ð¡Ð¾Ñ€ÑÐ½. Ð’Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸ Ð¾Ð± ÑÑ‚Ð¾Ð¼ Ð’ÐµÑ‚Ð°Ð»Ñƒ')
  }
})

module.exports = {
  initialize: async bot => {
    await dbClient.connect();
    bot.context.db = dbClient.db();
    console.log(`DB ${bot.context.db.databaseName} is initialized`)
  },
  botHandler: app
}

function createReportMessage({moonDay}) {
  if (!moonDay) return 'ÐÐµ Ð¼Ð¾Ð³Ñƒ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð»ÑƒÐ½Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ. Ð¡Ñ‚Ñ€Ð°Ð½Ð½Ð°Ñ Ð°ÑÑ‚Ñ€Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ð±ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°. Ð£Ñ‡Ñ‚Ð¸ ÑÑ‚Ð¾'

  const {dayNumber, dayStart, dayEnd} = moonDay;
  let leftHours = Math.floor(dayEnd.diff(DateTime.local(), 'hours').hours)
  let leftHoursMessage = leftHours ? `Ð§ÐµÑ€ÐµÐ· ${leftHours} ${getNoun(leftHours, 'Ñ‡Ð°Ñ', 'Ñ‡Ð°ÑÐ°', 'Ñ‡Ð°ÑÐ¾Ð²')}` : 'Ð¼ÐµÐ½ÐµÐµ Ñ‡ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ñ‡Ð°Ñ';


  let reportMessage =
    `Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð»ÑƒÐ½Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ: *${dayNumber}*
Ð”ÐµÐ½ÑŒ Ð½Ð°Ñ‡Ð°Ð»ÑÑ: _${dayStart.setLocale('ru').toLocaleString(DateTime.DATETIME_SHORT)}_
Ð”ÐµÐ½ÑŒ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑÑ: _${dayEnd.setLocale('ru').toLocaleString(DateTime.DATETIME_SHORT)}_
ÐÐ°Ñ‡Ð°Ð»Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾: _${leftHoursMessage}_
`
  return reportMessage
}

function getNoun(number, one, two, five) {
  let n = Math.abs(number);
  n %= 100;
  if (n >= 5 && n <= 20) {
    return five;
  }
  n %= 10;
  if (n === 1) {
    return one;
  }
  if (n >= 2 && n <= 4) {
    return two;
  }
  return five;
}

async function saveCoordinatesToChatsCollection(ctx, coordinates) {
  const [lat, lng] = coordinates
  const chatsCollection = ctx.db.collection('chats')
  return chatsCollection.updateOne(
    {chatId: ctx.message.chat.id},
    {$set: {chatId: ctx.message.chat.id, coordinates: [lat, lng]}},
    {upsert: true}
  );
}
